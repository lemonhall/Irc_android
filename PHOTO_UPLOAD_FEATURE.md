# IRC å®¢æˆ·ç«¯æ‹ç…§ä¸Šä¼ åŠŸèƒ½å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è§ˆ

æ·»åŠ äº†ä¸€ä¸ªå®Œæ•´çš„æ‹ç…§å’Œä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠçš„åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨èŠå¤©è¾“å…¥æ ä¸­ç‚¹å‡»æ‹ç…§æŒ‰é’®ï¼Œæ‹ç…§åè‡ªåŠ¨ä¸Šä¼ åˆ°é…ç½®çš„å›¾åºŠï¼Œç”Ÿæˆé“¾æ¥åé™„åŠ åˆ°èŠå¤©æ¶ˆæ¯ä¸­ã€‚

## å®ç°çš„åŠŸèƒ½æ¨¡å—

### 1. **å›¾ç‰‡ä¸Šä¼ ç®¡ç†å™¨** (`ImageUploadManager.kt`)
   - ä½ç½®: `app/src/main/java/com/lsl/irc_android/data/ImageUploadManager.kt`
   - åŠŸèƒ½:
     - ä»ç›¸æœº URI è¯»å–å’Œä¿å­˜å›¾ç‰‡åˆ°ç¼“å­˜
     - å‹ç¼©å›¾ç‰‡ä»¥å‡å°‘ä¸Šä¼ å¤§å°
     - ä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠï¼ˆæ”¯æŒ ImgBBã€Imgur ç­‰æ ‡å‡†å›¾åºŠ APIï¼‰
     - è§£æå›¾åºŠè¿”å›çš„ JSON å“åº”è·å–å›¾ç‰‡ URL
     - æ¸…ç†ç¼“å­˜ä¸­çš„å›¾ç‰‡æ–‡ä»¶

### 2. **HomeViewModel æ‰©å±•**
   - æ·»åŠ äº†å›¾ç‰‡ä¸Šä¼ ç›¸å…³çš„ LiveData:
     - `uploadingImage`: ç›‘å¬ä¸Šä¼ çŠ¶æ€ï¼ˆåŠ è½½ä¸­/å®Œæˆï¼‰
     - `uploadedImageUrl`: è·å–ä¸Šä¼ åçš„å›¾ç‰‡é“¾æ¥
   - æ–°å¢æ–¹æ³•:
     - `handleCameraImage()`: å¤„ç†ç›¸æœºæ‹ç…§åçš„å›¾ç‰‡ï¼Œè‡ªåŠ¨ä¸Šä¼ åˆ°å›¾åºŠ
     - `sendMessageWithImage()`: å‘é€åŒ…å«å›¾ç‰‡é“¾æ¥çš„æ¶ˆæ¯
     - åœ¨ `onCleared()` ä¸­æ·»åŠ æ¸…ç†ç¼“å­˜å›¾ç‰‡çš„é€»è¾‘

### 3. **HomeFragment æ‹ç…§åŠŸèƒ½**
   - ä½ç½®: `app/src/main/java/com/lsl/irc_android/ui/home/HomeFragment.kt`
   - åŠŸèƒ½:
     - åœ¨è¾“å…¥æ æ·»åŠ äº†"ğŸ“·"æ‹ç…§æŒ‰é’®
     - å®ç°äº†ç›¸æœºæƒé™è¯·æ±‚æµç¨‹
     - é›†æˆäº† Android çš„ç›¸æœº Intentï¼ˆæ”¯æŒ Android Q åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰
     - æ‹ç…§å®Œæˆåæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦ä¸Šä¼ 
     - ä¸Šä¼ ä¸­çŠ¶æ€ä¸‹ç¦ç”¨å‘é€å’Œæ‹ç…§æŒ‰é’®
     - ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨åœ¨è¾“å…¥æ¡†ä¸­æ’å…¥å›¾ç‰‡é“¾æ¥

### 4. **é…ç½®ç®¡ç†æ‰©å±•** (`IrcConfigManager.kt`)
   - æ·»åŠ äº†å›¾åºŠç›¸å…³çš„é…ç½®:
     - `imageHost`: å›¾åºŠçš„ä¸Šä¼  API URL
     - `apiKey`: å›¾åºŠçš„ API Key
     - é…ç½®æ”¯æŒ SharedPreferences æŒä¹…åŒ–

### 5. **UI å¸ƒå±€æ›´æ–°** (`fragment_home.xml`)
   - åœ¨æ¶ˆæ¯è¾“å…¥æ æ·»åŠ äº†æ‹ç…§æŒ‰é’®
   - æ‹ç…§æŒ‰é’®æ˜¾ç¤ºä¸º "ğŸ“·" emoji

### 6. **æƒé™é…ç½®** (`AndroidManifest.xml`)
   - æ·»åŠ äº†æ‰€éœ€æƒé™:
     - `CAMERA`: ä½¿ç”¨ç›¸æœº
     - `READ_EXTERNAL_STORAGE`: è¯»å–å¤–éƒ¨å­˜å‚¨
     - `WRITE_EXTERNAL_STORAGE`: å†™å…¥å¤–éƒ¨å­˜å‚¨
   - é…ç½®äº† FileProvider ç”¨äºä¿å­˜ç›¸æœºæ‹ç…§

### 7. **FileProvider é…ç½®** (`file_paths.xml`)
   - é…ç½®äº†æ–‡ä»¶è®¿é—®æƒé™è·¯å¾„
   - æ”¯æŒå¤–éƒ¨æ–‡ä»¶ç›®å½•ã€ç¼“å­˜ç›®å½•ç­‰

## ä½¿ç”¨æµç¨‹

### ç”¨æˆ·ä¾§æ“ä½œ
1. ç‚¹å‡»è¾“å…¥æ å·¦ä¾§çš„"ğŸ“·"æ‹ç…§æŒ‰é’®
2. ç³»ç»Ÿè¯·æ±‚ç›¸æœºæƒé™ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
3. å¯åŠ¨æ‰‹æœºç›¸æœºè¿›è¡Œæ‹ç…§
4. æ‹ç…§å®Œæˆåæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
5. é€‰æ‹©"ä¸Šä¼ "æŒ‰é’®ä¸Šä¼ å›¾ç‰‡
6. ä¸Šä¼ ä¸­æ˜¾ç¤ºåŠ è½½çŠ¶æ€
7. ä¸Šä¼ æˆåŠŸå Markdown æ ¼å¼çš„å›¾ç‰‡é“¾æ¥è‡ªåŠ¨æ’å…¥åˆ°è¾“å…¥æ¡†æœ€å‰é¢ï¼š`![å›¾ç‰‡](url) `
8. ç”¨æˆ·å¯ä»¥åœ¨å›¾ç‰‡é“¾æ¥åæ·»åŠ æ–‡å­—æè¿°åç‚¹å‡»å‘é€æŒ‰é’®å‘é€æ¶ˆæ¯
9. æœ€ç»ˆå‘é€çš„æ¶ˆæ¯æ ¼å¼ä¸ºï¼š`![å›¾ç‰‡](url) ç”¨æˆ·è¾“å…¥çš„æ–‡å­—æè¿°`

### æ¶ˆæ¯æ ¼å¼

åº”ç”¨ä½¿ç”¨ **Markdown å›¾ç‰‡è¯­æ³•** æ¥æ ‡è®°å›¾ç‰‡èµ„æºï¼š

```
![å›¾ç‰‡](https://i.ibb.co/xxx/img.jpg)
```

æˆ–å¸¦æœ‰æ–‡å­—æè¿°ï¼š

```
![å›¾ç‰‡](https://i.ibb.co/xxx/img.jpg) è¿™æ˜¯ä¸€å¼ ç¤ºä¾‹å›¾ç‰‡
```

#### æ ¼å¼ä¼˜åŠ¿

- **æ ‡å‡†æ ¼å¼** - ä½¿ç”¨å¹¿æ³›è®¤å¯çš„ Markdown è¯­æ³•
- **æ˜“äºè§£æ** - æ­£åˆ™è¡¨è¾¾å¼å¯è½»æ¾æå–ï¼š`!\[.*?\]\((.*?)\)`
- **æ˜“äºæ‰©å±•** - æ”¯æŒé“¾æ¥ã€åŠ ç²—ç­‰å…¶ä»– Markdown ç‰¹æ€§
- **Bot å‹å¥½** - æœåŠ¡ç«¯å¯ç”¨ Markdown è§£æåº“ç›´æ¥å¤„ç†

#### æœåŠ¡ç«¯è§£æå»ºè®®

**Python ç¤ºä¾‹ï¼š**
```python
import re
import markdown

def extract_image_urls(text):
    """ä»æ¶ˆæ¯ä¸­æå–å›¾ç‰‡ URL"""
    pattern = r'!\[.*?\]\((.*?)\)'
    urls = re.findall(pattern, text)
    return urls

def extract_text_without_images(text):
    """ç§»é™¤å›¾ç‰‡ Markdownï¼Œä¿ç•™æ–‡å­—"""
    pattern = r'!\[.*?\]\(.*?\)\s*'
    return re.sub(pattern, '', text).strip()

# ä½¿ç”¨
message = "![å›¾ç‰‡](https://i.ibb.co/xxx/img.jpg) è¿™æ˜¯æè¿°"
urls = extract_image_urls(message)  # ['https://i.ibb.co/xxx/img.jpg']
text = extract_text_without_images(message)  # 'è¿™æ˜¯æè¿°'
```

### å›¾åºŠé…ç½®

ç›®å‰éœ€è¦æ‰‹åŠ¨åœ¨ä»£ç ä¸­é…ç½®å›¾åºŠåœ°å€å’Œ API Keyã€‚å»ºè®®çš„é…ç½®æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šåœ¨è®¾ç½®ç•Œé¢ä¸­æ·»åŠ é…ç½®ï¼ˆæ¨èï¼‰
ç¼–è¾‘ `NotificationsFragment.kt` æˆ–åˆ›å»ºæ–°çš„è®¾ç½®ç•Œé¢ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®é€‰é¡¹ï¼š
- å›¾åºŠåœ°å€è¾“å…¥æ¡† (imageHost)
- API Key è¾“å…¥æ¡† (apiKey)

ç¤ºä¾‹é…ç½®ä»£ç ï¼š
```kotlin
val configManager = IrcConfigManager(context)
configManager.saveImageHost("https://api.imgbb.com/1/upload")
configManager.saveApiKey("your-api-key-here")
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨å…¬å…±å›¾åºŠæœåŠ¡
æ¨èä½¿ç”¨å…è´¹çš„å…¬å…±å›¾åºŠæœåŠ¡ï¼š

**ImgBB** (æ¨è)
- URL: `https://api.imgbb.com/1/upload`
- è·å– API Key: https://imgbb.com/
- ç‰¹ç‚¹: å…è´¹ã€æ”¯æŒè¾ƒå¤§æ–‡ä»¶ã€ä¿ç•™æ—¶é—´é•¿

**Imgur**
- URL: `https://api.imgur.com/3/image`
- è·å– API Key: https://api.imgur.com/oauth2/addclient
- ç‰¹ç‚¹: å…è´¹ã€å›½é™…çŸ¥åã€æ”¯æŒ HTTPS

## æŠ€æœ¯ç»†èŠ‚

### å›¾ç‰‡ä¸Šä¼ æµç¨‹
```
æ‹ç…§ â†’ ä¿å­˜åˆ°ç¼“å­˜ â†’ å‹ç¼© â†’ ä¸Šä¼ åˆ°å›¾åºŠ â†’ è§£æå“åº” â†’ è·å– URL â†’ æ’å…¥è¾“å…¥æ¡†
```

### æƒé™å¤„ç†
- ä½¿ç”¨ Android 13+ çš„ç°ä»£æƒé™ API (`ActivityResultContracts`)
- æ”¯æŒå‘ä¸‹å…¼å®¹åˆ° Android 6.0+
- ä¼˜é›…çš„æƒé™è¯·æ±‚å’Œæ‹’ç»å¤„ç†

### å›¾ç‰‡å‹ç¼©
- è‡ªåŠ¨å°†å¤§äº 1920x1920 çš„å›¾ç‰‡æŒ‰æ¯”ä¾‹ç¼©æ”¾
- JPEG å‹ç¼©è´¨é‡è®¾ç½®ä¸º 85%
- å‡å°‘ç½‘ç»œä¸Šä¼ æ—¶é—´å’Œæ•°æ®æ¶ˆè€—

### OkHttp é…ç½®
- è¿æ¥è¶…æ—¶: 30 ç§’
- è¯»å–è¶…æ—¶: 30 ç§’  
- å†™å…¥è¶…æ—¶: 30 ç§’
- æ”¯æŒ Multipart æ–‡ä»¶ä¸Šä¼ 

## åç»­å·¥ä½œ

### éœ€è¦é…ç½®çš„å†…å®¹
1. **è®¾ç½®ç•Œé¢é…ç½®** - åˆ›å»ºç”¨æˆ·å‹å¥½çš„å›¾åºŠé…ç½®ç•Œé¢
2. **å›¾åºŠé€‚é…** - æ ¹æ®ä¸åŒå›¾åºŠ API è°ƒæ•´å“åº”è§£æé€»è¾‘
3. **é”™è¯¯å¤„ç†** - ä¼˜åŒ–ç½‘ç»œé”™è¯¯æç¤ºå’Œé‡è¯•é€»è¾‘
4. **å›¾ç‰‡é¢„è§ˆ** - åœ¨å‘é€å‰æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆå¯é€‰ï¼‰

### å»ºè®®çš„æ”¹è¿›
1. æ”¯æŒå¤šä¸ªå›¾åºŠåˆ‡æ¢
2. ä¸Šä¼ è¿›åº¦æ¡æ˜¾ç¤º
3. å›¾ç‰‡ç¼“å­˜ç®¡ç†
4. ç¦»çº¿å›¾ç‰‡é˜Ÿåˆ—
5. æœ¬åœ°ç›¸å†Œé€‰æ‹©ï¼ˆè¡¥å……æ‹ç…§åŠŸèƒ½ï¼‰

## æ–‡ä»¶æ¸…å•

æ–°å¢æ–‡ä»¶ï¼š
- `app/src/main/java/com/lsl/irc_android/data/ImageUploadManager.kt`
- `app/src/main/res/xml/file_paths.xml`

ä¿®æ”¹æ–‡ä»¶ï¼š
- `app/src/main/java/com/lsl/irc_android/ui/home/HomeViewModel.kt`
- `app/src/main/java/com/lsl/irc_android/ui/home/HomeFragment.kt`
- `app/src/main/java/com/lsl/irc_android/data/IrcConfigManager.kt`
- `app/src/main/res/layout/fragment_home.xml`
- `app/build.gradle.kts`
- `gradle/libs.versions.toml`
- `app/src/main/AndroidManifest.xml`

## æ„å»ºå’Œæµ‹è¯•

```bash
# æ¸…ç†å¹¶æ„å»º
.\gradlew clean build

# æ„å»º Debug APK
.\gradlew assembleDebug

# å®‰è£…åˆ°è®¾å¤‡
adb install -r app/build/outputs/apk/debug/app-debug.apk

# è¿è¡Œåº”ç”¨
adb shell am start -n com.lsl.irc_android/.MainActivity
```

## ä¾èµ–åº“

æ–°å¢ä¾èµ–ï¼š
- `androidx.activity:activity-ktx:1.7.0` - ç”¨äº ActivityResultContracts
- `com.squareup.okhttp3:okhttp:4.11.0` - ç”¨äº HTTP è¯·æ±‚å’Œæ–‡ä»¶ä¸Šä¼ 

## æ³¨æ„äº‹é¡¹

1. **å›¾åºŠé…ç½®** - åœ¨é¦–æ¬¡ä½¿ç”¨å‰å¿…é¡»åœ¨è®¾ç½®ä¸­é…ç½®å›¾åºŠ URL å’Œ API Keyï¼Œå¦åˆ™æ‹ç…§åŠŸèƒ½æ— æ³•ä½¿ç”¨
2. **æƒé™è¯·æ±‚** - åº”ç”¨ä¼šåœ¨é¦–æ¬¡æ‹ç…§æ—¶è¯·æ±‚å¿…è¦æƒé™ï¼Œç”¨æˆ·éœ€è¦æˆäºˆæƒé™
3. **ç½‘ç»œç¯å¢ƒ** - å›¾ç‰‡ä¸Šä¼ éœ€è¦ç½‘ç»œè¿æ¥ï¼Œå»ºè®®åœ¨ WiFi ç¯å¢ƒä¸‹ä½¿ç”¨
4. **ç¼“å­˜æ¸…ç†** - åº”ç”¨å…³é—­æ—¶ä¼šè‡ªåŠ¨æ¸…ç†ç¼“å­˜å›¾ç‰‡ï¼Œä¸ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´
5. **æ–‡ä»¶æ ¼å¼** - ç›®å‰ä»…æ”¯æŒ JPEG æ ¼å¼ï¼Œæ‹ç…§åè‡ªåŠ¨è½¬æ¢

## å¸¸è§é—®é¢˜

**Q: æ‹ç…§åæ— æ³•ä¸Šä¼ å›¾ç‰‡ï¼Ÿ**
A: è¯·æ£€æŸ¥ï¼š
1. æ˜¯å¦åœ¨è®¾ç½®ä¸­é…ç½®äº†å›¾åºŠåœ°å€
2. API Key æ˜¯å¦æ­£ç¡®
3. æ‰‹æœºç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
4. æ£€æŸ¥åº”ç”¨æ—¥å¿—æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

**Q: ä¸ºä»€ä¹ˆä¸Šä¼ è¿™ä¹ˆæ…¢ï¼Ÿ**
A: å¯èƒ½åŸå› ï¼š
1. ç½‘ç»œè¿æ¥é€Ÿåº¦æ…¢
2. å›¾åºŠæœåŠ¡å™¨å“åº”æ…¢
3. å¯è€ƒè™‘åˆ‡æ¢åˆ°å…¶ä»–å›¾åºŠ

**Q: å¦‚ä½•æ›´æ¢å›¾åºŠï¼Ÿ**
A: åœ¨è®¾ç½®ä¸­é‡æ–°è¾“å…¥å›¾åºŠåœ°å€å’Œ API Key å³å¯

## ç›¸å…³æ–‡æ¡£

- [ImgBB API æ–‡æ¡£](https://api.imgbb.com/)
- [Imgur API æ–‡æ¡£](https://apidocs.imgur.com/)
- [Android ç›¸æœºå¼€å‘æŒ‡å—](https://developer.android.google.cn/guide/topics/media/camera)
- [Android æ–‡ä»¶è®¿é—®æŒ‡å—](https://developer.android.google.cn/training/data-storage)
